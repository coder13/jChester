/*
 *  jChester - v0.4.5
 *  A time entry component for speedcubing solves.
 *  https://github.com/jfly/jChester
 *
 *  Made by Jeremy Fleischman
 *  Under GPL-3.0 License
 */
!function(a){function b(a){return 0===a.length?!1:+a%1===0}var c=75,d=45;a.fn.jChester=function(e,f){if(!this.is("div"))throw"jChester can only be applied to divs";a.isPlainObject(e)&&(f=e,e=null);var g=["millis","moveCount","puzzlesSolvedCount","puzzlesAttemptedCount"],h=this,i=a.extend({},a.fn.jChester.defaults,f),j=this.data("datepicker");j||(j={},this.data("datepicker",j),j.$form=a('<form class="form-inline" role="form">'),h.append(j.$form),j.$form.append(a('<div class="form-group"><input name="millis" type="text" class="form-control"></input></div>')),j.$form.append(a('<div class="form-group"><input name="moveCount" type="text" class="form-control"></input></div>')),j.$form.append(document.createTextNode(" ")),j.$form.append(a('<div class="form-group"><input name="puzzlesSolvedCount" min="0" type="number" class="form-control"></input></div>')),j.$form.append(a('<span name="puzzlesAttemptedCount">&nbsp;/&nbsp;</span>')),j.$form.append(a('<div class="form-group"><input name="puzzlesAttemptedCount" min="0" type="number" class="form-control"></input></div>')),j.$form.append(a('<span class="help-block">')),j.$form.find('input[type="text"]').width(c),j.$form.find('input[type="number"]').width(d),j.$form.find(".form-group").css({display:"inline-block"}),j.inputChanged=function(){var c={},d={};if(j.editableSolveTimeFields.millis){var e=j.$form.find('input[name="millis"]').val();try{a.extend(d,a.stopwatchFormatToSolveTime(e))}catch(f){c.millis=0===e.length?"Please enter a time.":f}}if(j.editableSolveTimeFields.moveCount){var h=j.$form.find('input[name="moveCount"]').val();try{a.extend(d,a.stopwatchFormatToSolveTime(h))}catch(f){c.moveCount=0===h.length?"Please enter a number of moves.":f}}var i,k;if(j.hideField={},a.solveTimeIsDNF(d))i="0",k="1",j.hideField.puzzlesSolvedCount=!0,j.hideField.puzzlesAttemptedCount=!0;else if(a.solveTimeIsDNS(d))i="0",k="0",j.hideField.puzzlesSolvedCount=!0,j.hideField.puzzlesAttemptedCount=!0;else if(j.editableSolveTimeFields.puzzlesSolvedCount||j.editableSolveTimeFields.puzzlesAttemptedCount){var l=j.$form.find('input[name="puzzlesSolvedCount"]');i=l.val();var m=j.$form.find('input[name="puzzlesAttemptedCount"]');k=m.val()}else i="1",k="1";if(b(i)){var n=parseInt(i);d.puzzlesSolvedCount=n}else c.puzzlesSolvedCount="Invalid number of puzzles solved.";if(b(k)){var o=parseInt(k);d.puzzlesAttemptedCount=o,!c.puzzlesSolvedCount&&d.puzzlesSolvedCount>d.puzzlesAttemptedCount&&(c.puzzlesAttemptedCount="Cannot have more puzzles solved than attemped.")}else c.puzzlesAttemptedCount="Invalid number of puzzles attempted.";var p=function(a){return c[a]},q=g.filter(p).map(p);q.length>0&&(d=null),j.solveTime=d,j.$form.find(".help-block").text(q.join(" ")),j.$form.find(".input-group").removeClass("has-error"),g.forEach(function(a){var b=j.$form.find('input[name="'+a+'"]'),d=b.parent(".form-group"),e=!!c[a];d.toggleClass("has-error",e)}),g.forEach(function(a){var b=j.editableSolveTimeFields[a]&&!j.hideField[a];b=!!b,j.$form.find('input[name="'+a+'"]').parent().toggle(b),j.$form.find('span[name="'+a+'"]').toggle(b)})},j.$form.find("input").on("input",function(){j.inputChanged(),h.trigger("solveTimeInput",[j.solveTime])}),j.$form.find("input").on("keydown",function(b){var c=a(b.currentTarget);("millis"===c.attr("name")||"moveCount"===c.attr("name"))&&!b.altKey&&!b.ctrlKey&!b.metaKey&&(106===b.which||68===b.which?(c.val("DNF"),j.inputChanged(),h.trigger("solveTimeInput",[j.solveTime]),b.preventDefault()):(111===b.which||83===b.which)&&(c.val("DNS"),j.inputChanged(),h.trigger("solveTimeInput",[j.solveTime]),b.preventDefault())),13===b.which&&(j.inputChanged(),h.trigger("solveTimeChange",[j.solveTime]))}),this.attr("tabindex","-1"),this.focus(function(){var b=a(this).find("input").first();b.focus(),b.select()}));var k=function(b){null===b?(j.$form.find('input[name="millis"]').val(""),j.$form.find('input[name="moveCount"]').val(""),j.$form.find('input[name="puzzlesSolvedCount"]').val(""),j.$form.find('input[name="puzzlesAttemptedCount"]').val(""),j.inputChanged()):b&&(j.$form.find('input[name="millis"]').val(a.solveTimeToStopwatchFormat(b)),j.$form.find('input[name="moveCount"]').val(b.moveCount),j.$form.find('input[name="puzzlesSolvedCount"]').val(b.puzzlesSolvedCount),j.$form.find('input[name="puzzlesAttemptedCount"]').val(b.puzzlesAttemptedCount),j.inputChanged())};if("getSolveTime"===e)return j.solveTime;if("setSolveTime"===e){var l=arguments[1];return void k(l)}if(e)throw"Unrecognized method: "+e;return j.editableSolveTimeFields=i.editableSolveTimeFields,j.inputChanged(),k(i.solveTime),h},a.fn.jChester.defaults={solveTime:null,editableSolveTimeFields:{millis:!0}};var e=1e3,f=60*e;a.extend({stopwatchFormatToSolveTime:function(a,c){if("DNF"===a.toUpperCase())return{puzzlesSolvedCount:0,puzzlesAttemptedCount:1};if("DNS"===a.toUpperCase())return{puzzlesSolvedCount:0,puzzlesAttemptedCount:0};if(c){if(!b(a))throw"Invalid move count";var d=parseInt(a);if(0>=d)throw"Move count must be greater than zero";return{moveCount:d}}var g=a.match(/^(?:(\d*):)?(\d+)(?:[.,](\d*))?$/);if(!g)throw"Invalid stopwatch format";var h=parseInt(g[1]||"0"),i=parseInt(g[2]),j=g[3]||"",k=parseInt(j||"0"),l=Math.pow(10,k.toString().length-3),m=k?Math.round(k/l):0,n=h*f+i*e+m,o=Math.min(3,j.length);return{millis:n,decimals:o}},solveTimeIsDNF:function(a){if("undefined"!=typeof a.puzzlesSolvedCount&&"undefined"!=typeof a.puzzlesAttemptedCount)if(1===a.puzzlesAttemptedCount){if(0===a.puzzlesSolvedCount)return!0}else if(a.puzzlesAttemptedCount>1){var b=a.puzzlesAttemptedCount-a.puzzlesSolvedCount,c=a.puzzlesSolvedCount-b;if(0>c||1===a.puzzlesSolvedCount)return!0}return!1},solveTimeIsDNS:function(a){return"undefined"!=typeof a.puzzlesAttemptedCount&&0===a.puzzlesAttemptedCount?!0:!1},solveTimeToStopwatchFormat:function(b){function c(a,b,c){for(var d=a+"";d.length<c;)d=b+d;return d}if(a.solveTimeIsDNF(b))return"DNF";if(a.solveTimeIsDNS(b))return"DNS";var d=b.millis,e=Math.floor(d/6e4);d%=6e4;var f=Math.floor(d/1e3);d%=1e3;var g;g=e?e+":"+c(f,"0",2):""+f;var h=b.decimals;if(h>0){h=Math.min(3,h);var i=c(d,"0",3);g+=".";for(var j=0;h>j;j++)g+=i.charAt(j)}return g}})}(jQuery);